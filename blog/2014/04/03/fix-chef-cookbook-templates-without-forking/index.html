
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fix Chef Cookbook Templates Without Forking - Technology.</title>
  <meta name="author" content="Mike Splain">

  
  <meta name="description" content="One of the key features with Chef is reusability, which is why many teams have started using Application Cookbooks (as described here). In my &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mikesplain.github.io/blog/blog/2014/04/03/fix-chef-cookbook-templates-without-forking">
  <link href="/blog/blog/favicon.png" rel="icon">
  <link href="/blogblog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/blog/atom.xml" rel="alternate" title="Technology." type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./blog/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="/blog/fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/blog/fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49717104-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog">Technology.</a></h1>
  
    <h2>My thoughts on tech, etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mikesplain.github.io/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blogabout-me">About Me</a></li>
  <li><a href="/blogblog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fix Chef Cookbook Templates Without Forking</h1>
    
    
      <p class="meta">
        








  



<time datetime="2014-04-03T23:25:12-04:00" pubdate data-updated="true">Apr 3<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>One of the key features with Chef is reusability, which is why many teams have started using Application Cookbooks (as <a href="http://alluvium.com/blog/2013/05/03/the-application-cookbook-pattern-berkshelf-and-team-chef-workflow/">described here</a>).  In my experience, application cookbooks are a game changer and make development, testing, and deployment simple.  That being said, app cookbooks create their own set of issues as well&hellip;</p>

<p>Our team has worked to use community cookbooks when possible to build out an environment, but there are often times a cookbook may be missing a simple line or an attribute required for your use case.  When that happens you have a number of options:</p>

<ul>
<li>Fork the community cookbook and make your own.</li>
<li>Put in a pull request for the feature you require.</li>
<li>Put in a FileEdit hack to insert configs after an &ldquo;include_recipe&rdquo; converge</li>
<li>Override the template.</li>
</ul>


<p>Now all of these options are completely feasible, however lets break them down.</p>

<h2>Forking the community cookbook and make it your own</h2>

<p>Now this was the early way many Chef&rsquo;s used while the community was young.  Unless you have time to spend upkeeping your cookbooks, many can be left to the community to manage.  Forking them makes it challenging to track upstream changes and usually get off track.</p>

<h2>Put in a pull request for the feature you require.</h2>

<p>Pull requests are great and I think this is the best option, however, lets be honest, there&rsquo;s many a time I would love to put in a PR but need the issue fixed immediately. In that case, your PR and fork generally are put into use immediately and not through the community, resulting in the same issue as above.</p>

<h2>Put in a FileEdit hack to insert configs after an &ldquo;include_recipe&rdquo; converge</h2>

<p>This solution that avoids two of the above issues, but also causes some of it&rsquo;s own.</p>

<p>Lets say you&rsquo;re building a tomcat based app and have used the <a href="https://github.com/opscode-cookbooks/tomcat">community cookbook</a>.  Now when you load the WAR into your project, you want to mount it on the base rather than www.example.com/appname.  Of course there are many ways to solve this including tools like nginx but rewrites cause other issues with sessions and cookies&hellip; so lets mount it the way our developer requests.  Unfortunately the cookbook does not provide functionality to edit the docBase Context or insert it as an attribute.  Lets insert it by hand:</p>

<figure class='code'><figcaption><span>/recipes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby_block</span> <span class="s2">&quot;Fix Tomcat&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Lets add a line to fix tomcat docBase&quot;</span>
</span><span class='line'>    <span class="n">file</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Util</span><span class="o">::</span><span class="no">FileEdit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">node</span><span class="o">[</span><span class="ss">:tomcat</span><span class="o">][</span><span class="ss">:config_dir</span><span class="o">]</span> <span class="o">+</span> <span class="s2">&quot;/server.xml&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">file</span><span class="o">.</span><span class="n">insert_line_after_match</span><span class="p">(</span>
</span><span class='line'>    <span class="s2">&quot;&lt;\!-- Access log processes all example.&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        # Added Via Chef:</span><span class="se">\n</span><span class="s2">        &lt;Context docBase=</span><span class="se">\&quot;</span><span class="s2">appname</span><span class="se">\&quot;</span><span class="s2"> path=</span><span class="se">\&quot;\&quot;</span><span class="s2"> reloadable=</span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">        &lt;!-- Access log processes all example.&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">file</span><span class="o">.</span><span class="n">write_file</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that works but if your do a full run of chef, you&rsquo;ll notice that your tomcat will restart and the file will first be cleansed back to it&rsquo;s original state, then the edit will be readded.  Well that&rsquo;s painful and ugly.</p>

<h2>Override the template.</h2>

<p>This is my preferred method and the best of both worlds.  Instead of forking a cookbook or hacking in a change, we take the existing template, copy it into our app cookbook, insert our configs and reference our edited template like such:</p>

<figure class='code'><figcaption><span>/recipes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="n">r</span> <span class="o">=</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:tomcat</span><span class="o">][</span><span class="ss">:config_dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/server.xml&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">r</span><span class="o">.</span><span class="n">cookbook</span> <span class="s2">&quot;appcookbook&quot;</span>
</span><span class='line'><span class="k">rescue</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">ResourceNotFound</span>
</span><span class='line'>  <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&quot;could not find template to override!&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some argue that this is very similar to a full fork of a cookbook however I believe it&rsquo;s the best solution for the job.  To accompany this change (and always), you should lock the version of the included cookbook in your metadata.rb file to prevent the community cookbook from breaking if the template is changed in the future.</p>

<p>Any alternative ideas or suggestions are welcome (if I can ever get disqus to show up)!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mike Splain</span></span>

      








  



<time datetime="2014-04-03T23:25:12-04:00" pubdate data-updated="true">Apr 3<span>rd</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/chef/'>chef</a>, <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="/blog/twitter.com/share" class="twitter-share-button" data-url="http://mikesplain.github.io/blog/blog/2014/04/03/fix-chef-cookbook-templates-without-forking/" data-via="mikesplain" data-counturl="http://mikesplain.github.io/blog/blog/2014/04/03/fix-chef-cookbook-templates-without-forking/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blogblog/2014/04/03/a-new-beginning/" title="Previous Post: A new beginning">&laquo; A new beginning</a>
      
      
        <a class="basic-alignment right" href="/blogblog/2014/06/01/compiling-textual/" title="Next Post: Compiling Textual">Compiling Textual &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blogblog/2014/06/01/compiling-textual/">Compiling Textual</a>
      </li>
    
      <li class="post">
        <a href="/blogblog/2014/04/03/fix-chef-cookbook-templates-without-forking/">Fix Chef Cookbook Templates Without Forking</a>
      </li>
    
      <li class="post">
        <a href="/blogblog/2014/04/03/a-new-beginning/">A New Beginning</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mikesplain">@mikesplain</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/blog/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mikesplain',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/blog"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    <a href="https://twitter.com/mikesplain"><img src="/blog/images/glyphicons_social_31_twitter.png"/></a>
    <a href="https://github.com/mikesplain"><img src="/blog/images/glyphicons_social_21_github.png"/></a>
    <a href="mailto:mike.splain@gmail.com"><img src="/blog/images/glyphicons_social_39_e-mail.png"/></a>
  </div>
</div>

    </div>
  </div>
</footer>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mikesplaingithubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mikesplain.github.io/blog/blog/2014/04/03/fix-chef-cookbook-templates-without-forking/';
        var disqus_url = 'http://mikesplain.github.io/blog/blog/2014/04/03/fix-chef-cookbook-templates-without-forking/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
